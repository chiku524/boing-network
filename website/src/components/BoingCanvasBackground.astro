---
/**
 * Canvas-based aquatic-space background using boing-bg-engine.
 * Fallback: boing-aquatic-space-bg.webp when reduced-motion or engine fails.
 * Uses BOING_BG_CONFIGS.network with route â†’ config key mapping.
 */
interface Props {
  /** Current path (e.g. from Astro.url.pathname) for config selection */
  path?: string;
}

const { path = '/' } = Astro.props;
const normalizedPath = (path || '/').replace(/\/$/, '') || '';
---

<div class="boing-canvas-bg" data-path={normalizedPath} aria-hidden="true">
  <!-- Fallback: static .webp when reduced-motion or when Canvas engine has issues -->
  <div class="boing-canvas-bg-fallback"></div>
  <canvas id="boing-bg-canvas" class="boing-canvas-bg-canvas"></canvas>
</div>

<script>
  import { BoingBackground, BOING_BG_CONFIGS } from '../lib/boing-bg-engine.js';

  function getConfigKey(path) {
    if (path.startsWith('/docs') || path.startsWith('/developers')) return 'developers';
    if (path === '/about') return 'pillars';
    return 'landing';
  }

  function showFallback(wrap, fallback) {
    if (!wrap) return;
    wrap.classList.add('reduced-motion');
    fallback?.classList.add('visible');
  }

  function init() {
    const wrap = document.querySelector('.boing-canvas-bg');
    const canvas = document.getElementById('boing-bg-canvas');
    const fallback = wrap?.querySelector('.boing-canvas-bg-fallback');
    if (!wrap || !canvas) return;

    const path = wrap.dataset.path || '/';
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    if (prefersReducedMotion) {
      showFallback(wrap, fallback);
      return;
    }

    try {
      const configKey = getConfigKey(path);
      const networkConfigs = BOING_BG_CONFIGS.network;
      const config = networkConfigs[configKey] || networkConfigs.landing;
      const bg = new BoingBackground(canvas, config);
      bg.start();
      wrap.classList.remove('reduced-motion');
      fallback?.classList.remove('visible');
    } catch (err) {
      showFallback(wrap, fallback);
    }
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
</script>

<style>
  .boing-canvas-bg {
    position: fixed;
    inset: 0;
    z-index: 0;
    pointer-events: none;
    overflow: hidden;
  }

  /* Fallback: boing-aquatic-space-bg.webp with dark overlay for readability */
  .boing-canvas-bg-fallback {
    position: absolute;
    inset: 0;
    background-color: #020408;
    background-image: url('/assets/boing-aquatic-space-bg.webp');
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .boing-canvas-bg-fallback::after {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(180deg, rgba(2, 4, 8, 0.4) 0%, rgba(2, 4, 8, 0.65) 100%);
    pointer-events: none;
  }

  .boing-canvas-bg-fallback.visible {
    opacity: 1;
  }

  .boing-canvas-bg-canvas {
    display: block;
    width: 100%;
    height: 100%;
    width: 100vw;
    height: 100vh;
    position: absolute;
    inset: 0;
  }

  .boing-canvas-bg.reduced-motion .boing-canvas-bg-canvas {
    visibility: hidden;
  }

  @media (prefers-reduced-motion: reduce) {
    .boing-canvas-bg-fallback {
      opacity: 1;
    }
  }
</style>
